import { ChangeDetectorRef, Component, EventEmitter, forwardRef, Inject, Input, Output, ViewChild } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { MatAutocompleteTrigger } from '@angular/material/autocomplete';
import { BehaviorSubject, combineLatest, fromEvent, Subject } from 'rxjs';
import { debounceTime, startWith, takeUntil } from 'rxjs/operators';
import { MatSelectCountryLangToken } from './tokens';
import { MatInput } from '@angular/material/input';
/**
 * @author Anthony Nahas
 * @since 11.19
 * @version 2.1.0
 */
export class MatSelectCountryComponent {
    constructor(i18n, cdRef) {
        this.i18n = i18n;
        this.cdRef = cdRef;
        this.countries = [];
        this.placeHolder = 'Select country';
        this.showCallingCode = false;
        this.excludedCountries = [];
        // tslint:disable-next-line: no-output-on-prefix
        this.onCountrySelected = new EventEmitter();
        this.debounceTime = 300;
        this.filterString = '';
        this.modelChanged = new Subject();
        this.countries$ = new BehaviorSubject([]);
        this.excludedCountries$ = new BehaviorSubject([]);
        this.value$ = new BehaviorSubject(null);
        this.unsubscribe$ = new Subject();
        this.propagateChange = (_) => { };
    }
    get value() {
        return this._value;
    }
    set value(value) {
        // setting a value on a reactive form (formControlName) doesn't trigger ngOnChanges but it does call this setter
        this.value$.next(value);
    }
    ngOnInit() {
        combineLatest([
            this.countries$,
            this.value$,
            this.excludedCountries$
        ])
            .pipe(
        // fixing the glitch on combineLatest https://blog.strongbrew.io/combine-latest-glitch/
        debounceTime(0), takeUntil(this.unsubscribe$))
            .subscribe(([countries, value, excludedCountries]) => {
            this._populateCountries(countries, excludedCountries);
            if (value) {
                this._setValue(value);
            }
        });
        if (!this.countries.length) {
            this._loadCountriesFromDb();
        }
        this.modelChanged
            .pipe(startWith(''), debounceTime(this.debounceTime), takeUntil(this.unsubscribe$))
            .subscribe((value) => {
            this.filterString = value;
            this._filter(value);
        });
    }
    ngOnChanges(changes) {
        var _a, _b;
        if ((_a = changes.countries) === null || _a === void 0 ? void 0 : _a.currentValue) {
            this.countries$.next(changes.countries.currentValue);
        }
        if ((_b = changes.excludedCountries) === null || _b === void 0 ? void 0 : _b.currentValue) {
            this.excludedCountries$.next(changes.excludedCountries.currentValue);
        }
    }
    onBlur() {
        if (!this.inputElement.value && this.nullable && this.statesAutocompleteRef.panel) {
            this._setValue(null);
            this.onCountrySelected.emit(null);
        }
    }
    onOptionsSelected($event) {
        const value = this.countries.find((country) => country.name === $event.option.value);
        this._setValue(value);
        this.onCountrySelected.emit(value);
    }
    writeValue(obj) {
        if (obj) {
            this.value = obj;
        }
    }
    registerOnChange(fn) {
        this.propagateChange = fn;
    }
    registerOnTouched(fn) {
        // throw new Error('Method not implemented.');
    }
    setDisabledState(isDisabled) {
        this.disabled = isDisabled;
    }
    autocompleteScroll() {
        if (this.itemsLoadSize) {
            setTimeout(() => {
                if (this.statesAutocompleteRef &&
                    this.autocompleteTrigger &&
                    this.statesAutocompleteRef.panel) {
                    fromEvent(this.statesAutocompleteRef.panel.nativeElement, 'scroll')
                        .pipe(takeUntil(this.autocompleteTrigger.panelClosingActions))
                        .subscribe(() => {
                        const scrollTop = this.statesAutocompleteRef.panel.nativeElement
                            .scrollTop;
                        const scrollHeight = this.statesAutocompleteRef.panel
                            .nativeElement.scrollHeight;
                        const elementHeight = this.statesAutocompleteRef.panel
                            .nativeElement.clientHeight;
                        const atBottom = scrollHeight === scrollTop + elementHeight;
                        if (atBottom) {
                            // fetch more data if not filtered
                            if (this.filterString === '') {
                                const fromIndex = this.filteredOptions.length;
                                const toIndex = +this.filteredOptions.length + +this.itemsLoadSize;
                                this.filteredOptions = [
                                    ...this.filteredOptions,
                                    ...this.countries.slice(fromIndex, toIndex),
                                ];
                            }
                        }
                    });
                }
            });
        }
    }
    inputChanged(value) {
        this.modelChanged.next(value);
    }
    ngOnDestroy() {
        this.unsubscribe$.next();
        this.unsubscribe$.complete();
    }
    _loadCountriesFromDb() {
        this.loadingDB = true;
        this._importLang(this.i18n)
            .then((res) => {
            this.countries$.next(res);
        })
            .catch((err) => console.error('Error: ' + err))
            .finally(() => this.loadingDB = false);
    }
    _populateCountries(countries, excludedCountries) {
        const excludeCountries = excludedCountries.map(c => c.alpha2Code);
        this.countries = countries.filter(c => !excludeCountries.includes(c.alpha2Code));
    }
    _setValue(value) {
        if (value && (!value.name || value.name === 'Unknown')) {
            // lookup name based on alpha2 values could be extended to lookup on other values too
            const matchingCountry = this.countries.find((c) => c.alpha2Code === value.alpha2Code);
            if (!!matchingCountry) {
                value = matchingCountry;
            }
        }
        this._value = (value === null || value === void 0 ? void 0 : value.name) ? value : null;
        this.propagateChange(this._value);
    }
    _importLang(i18n) {
        switch (i18n) {
            case 'br':
                return import('./i18n/br').then(result => result.COUNTRIES_DB_BR).then(y => y);
            case 'by':
                return import('./i18n/by').then(result => result.COUNTRIES_DB_BY).then(y => y);
            case 'de':
                return import('./i18n/de').then(result => result.COUNTRIES_DB_DE).then(y => y);
            case 'es':
                return import('./i18n/es').then(result => result.COUNTRIES_DB_ES).then(y => y);
            case 'fr':
                return import('./i18n/fr').then(result => result.COUNTRIES_DB_FR).then(y => y);
            case 'hr':
                return import('./i18n/hr').then(result => result.COUNTRIES_DB_HR).then(y => y);
            case 'it':
                return import('./i18n/it').then(result => result.COUNTRIES_DB_IT).then(y => y);
            case 'nl':
                return import('./i18n/nl').then(result => result.COUNTRIES_DB_NL).then(y => y);
            case 'pt':
                return import('./i18n/pt').then(result => result.COUNTRIES_DB_PT).then(y => y);
            case 'ru':
                return import('./i18n/ru').then(result => result.COUNTRIES_DB_RU).then(y => y);
            case 'ua':
                return import('./i18n/ua').then(result => result.COUNTRIES_DB_UA).then(y => y);
            case 'gl':
                return import('./i18n/gl').then(result => result.COUNTRIES_DB_GL).then(y => y);
            case 'eu':
                return import('./i18n/eu').then(result => result.COUNTRIES_DB_EU).then(y => y);
            case 'ca':
                return import('./i18n/ca').then(result => result.COUNTRIES_DB_CA).then(y => y);
            default:
                return import('./i18n/en').then(result => result.COUNTRIES_DB).then(y => y);
        }
    }
    _filter(value) {
        const filterValue = value.toLowerCase();
        // if not filtered, fetch reduced array
        if (this.itemsLoadSize && filterValue === '') {
            this.filteredOptions = this.countries.slice(0, this.itemsLoadSize);
        }
        else {
            this.filteredOptions = this.countries.filter((option) => option.name.toLowerCase().includes(filterValue) ||
                option.alpha2Code.toLowerCase().includes(filterValue) ||
                option.alpha3Code.toLowerCase().includes(filterValue));
        }
        // options in the UI are not updated when this component is used within a host component that uses OnPush
        this.cdRef.markForCheck();
    }
}
MatSelectCountryComponent.decorators = [
    { type: Component, args: [{
                selector: 'mat-select-country',
                template: "<mat-form-field [appearance]=\"appearance\">\n    <mat-label *ngIf=\"label\">{{label}}</mat-label>\n    <mat-icon *ngIf=\"this.value\" [svgIcon]=\"this.value?.alpha2Code?.toLowerCase()\" class=\"mr-12 s-20 secondary-text\"\n              matSuffix></mat-icon>\n    <input (blur)=\"onBlur()\" (input)=\"inputChanged($event?.target?.value)\"\n           [class]=\"class\"\n           [matAutocomplete]=\"this.countryAutocomplete\"\n           [placeholder]=\"this.placeHolder\"\n           [readonly]=\"this.readonly\"\n           [tabIndex]=\"tabIndex\"\n           [value]=\"showCallingCode ? this.value?.callingCode : this.value?.name\"\n           [required]=\"this.required\"\n           [disabled]=\"this.disabled || this.loadingDB\"\n           [autocomplete]=\"browserAutocomplete\"\n           aria-label=\"country\"\n           matInput type=\"text\"\n           #inputElement>\n    <mat-progress-bar *ngIf=\"this.loadingDB || this.loading\" mode=\"buffer\"></mat-progress-bar>\n    <mat-autocomplete #countryAutocomplete=\"matAutocomplete\" (opened)=\"autocompleteScroll()\"\n                      (optionSelected)=\"onOptionsSelected($event)\">\n        <mat-option *ngFor=\"let country of filteredOptions\" [value]=\"country?.name\">\n            <mat-icon [svgIcon]=\"country?.alpha2Code?.toLowerCase()\"></mat-icon>\n            <small *ngIf=\"!showCallingCode\">{{ [country?.name, country?.alpha3Code] | joinStrings }}</small>\n            <small *ngIf=\"showCallingCode\">{{ [country?.name, '(' + country?.callingCode + ')'] | joinStrings:' ' }}</small>\n        </mat-option>\n    </mat-autocomplete>\n</mat-form-field>\n",
                providers: [
                    {
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef(() => MatSelectCountryComponent),
                        multi: true,
                    },
                ],
                styles: [""]
            },] }
];
MatSelectCountryComponent.ctorParameters = () => [
    { type: String, decorators: [{ type: Inject, args: [forwardRef(() => MatSelectCountryLangToken),] }] },
    { type: ChangeDetectorRef }
];
MatSelectCountryComponent.propDecorators = {
    appearance: [{ type: Input }],
    countries: [{ type: Input }],
    label: [{ type: Input }],
    placeHolder: [{ type: Input }],
    required: [{ type: Input }],
    disabled: [{ type: Input }],
    nullable: [{ type: Input }],
    readonly: [{ type: Input }],
    tabIndex: [{ type: Input }],
    class: [{ type: Input }],
    itemsLoadSize: [{ type: Input }],
    loading: [{ type: Input }],
    showCallingCode: [{ type: Input }],
    excludedCountries: [{ type: Input }],
    browserAutocomplete: [{ type: Input }],
    statesAutocompleteRef: [{ type: ViewChild, args: ['countryAutocomplete',] }],
    autocompleteTrigger: [{ type: ViewChild, args: [MatAutocompleteTrigger,] }],
    inputElement: [{ type: ViewChild, args: [MatInput,] }],
    onCountrySelected: [{ type: Output }],
    value: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0LXNlbGVjdC1jb3VudHJ5LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItbWF0ZXJpYWwtZXh0ZW5zaW9ucy9zZWxlY3QtY291bnRyeS9zcmMvbGliL21hdC1zZWxlY3QtY291bnRyeS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsWUFBWSxFQUNaLFVBQVUsRUFDVixNQUFNLEVBQ04sS0FBSyxFQUlMLE1BQU0sRUFFTixTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUF3QixpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pFLE9BQU8sRUFBaUQsc0JBQXNCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUV2SCxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFnQm5EOzs7O0dBSUc7QUFhSCxNQUFNLE9BQU8seUJBQXlCO0lBd0NwQyxZQUM4RCxJQUFZLEVBQ2hFLEtBQXdCO1FBRDRCLFNBQUksR0FBSixJQUFJLENBQVE7UUFDaEUsVUFBSyxHQUFMLEtBQUssQ0FBbUI7UUF2Q3pCLGNBQVMsR0FBYyxFQUFFLENBQUM7UUFFMUIsZ0JBQVcsR0FBRyxnQkFBZ0IsQ0FBQztRQVMvQixvQkFBZSxHQUFHLEtBQUssQ0FBQztRQUN4QixzQkFBaUIsR0FBeUMsRUFBRSxDQUFDO1FBT3RFLGdEQUFnRDtRQUN0QyxzQkFBaUIsR0FBMEIsSUFBSSxZQUFZLEVBQVcsQ0FBQztRQUtqRixpQkFBWSxHQUFHLEdBQUcsQ0FBQztRQUNuQixpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUVWLGlCQUFZLEdBQW9CLElBQUksT0FBTyxFQUFVLENBQUM7UUFDdEQsZUFBVSxHQUFHLElBQUksZUFBZSxDQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ2hELHVCQUFrQixHQUFHLElBQUksZUFBZSxDQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ3hELFdBQU0sR0FBRyxJQUFJLGVBQWUsQ0FBVSxJQUFJLENBQUMsQ0FBQztRQUM1QyxpQkFBWSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFvQjNDLG9CQUFlLEdBQUcsQ0FBQyxDQUFNLEVBQUUsRUFBRSxHQUFFLENBQUMsQ0FBQztJQVo5QixDQUFDO0lBRUosSUFBSSxLQUFLO1FBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxJQUNJLEtBQUssQ0FBQyxLQUFjO1FBQ3RCLGdIQUFnSDtRQUNoSCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBSUQsUUFBUTtRQUNOLGFBQWEsQ0FBQztZQUNaLElBQUksQ0FBQyxVQUFVO1lBQ2YsSUFBSSxDQUFDLE1BQU07WUFDWCxJQUFJLENBQUMsa0JBQWtCO1NBQ3hCLENBQUM7YUFDQyxJQUFJO1FBQ0gsdUZBQXVGO1FBQ3ZGLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFDZixTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUM3QjthQUNBLFNBQVMsQ0FBQyxDQUFFLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxpQkFBaUIsQ0FBQyxFQUFHLEVBQUU7WUFDckQsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1lBQ3RELElBQUksS0FBSyxFQUFFO2dCQUNULElBQUksQ0FBQyxTQUFTLENBQUUsS0FBSyxDQUFFLENBQUM7YUFDekI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVMLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRTtZQUMxQixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztTQUM3QjtRQUVELElBQUksQ0FBQyxZQUFZO2FBQ2QsSUFBSSxDQUNILFNBQVMsQ0FBQyxFQUFFLENBQUMsRUFDYixZQUFZLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUMvQixTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUM3QjthQUNBLFNBQVMsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ25CLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO1lBQzFCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsV0FBVyxDQUFDLE9BQXNCOztRQUNoQyxJQUFJLE1BQUEsT0FBTyxDQUFDLFNBQVMsMENBQUUsWUFBWSxFQUFFO1lBQ25DLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDdEQ7UUFFRCxJQUFJLE1BQUEsT0FBTyxDQUFDLGlCQUFpQiwwQ0FBRSxZQUFZLEVBQUU7WUFDM0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDdEU7SUFDSCxDQUFDO0lBRUQsTUFBTTtRQUNKLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLEVBQUU7WUFDakYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ25DO0lBQ0gsQ0FBQztJQUVELGlCQUFpQixDQUFDLE1BQW9DO1FBQ3BELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUMvQixDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksS0FBSyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDbEQsQ0FBQztRQUNGLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRUQsVUFBVSxDQUFDLEdBQVE7UUFDakIsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztTQUNsQjtJQUNILENBQUM7SUFFRCxnQkFBZ0IsQ0FBQyxFQUFPO1FBQ3RCLElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxFQUFPO1FBQ3ZCLDhDQUE4QztJQUNoRCxDQUFDO0lBRUQsZ0JBQWdCLENBQUUsVUFBbUI7UUFDbkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxVQUFVLENBQUM7SUFDN0IsQ0FBQztJQUVELGtCQUFrQjtRQUNoQixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtnQkFDZCxJQUNFLElBQUksQ0FBQyxxQkFBcUI7b0JBQzFCLElBQUksQ0FBQyxtQkFBbUI7b0JBQ3hCLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLEVBQ2hDO29CQUNBLFNBQVMsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUM7eUJBQ2hFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLENBQUM7eUJBQzdELFNBQVMsQ0FBQyxHQUFHLEVBQUU7d0JBQ2QsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxhQUFhOzZCQUM3RCxTQUFTLENBQUM7d0JBQ2IsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLEtBQUs7NkJBQ2xELGFBQWEsQ0FBQyxZQUFZLENBQUM7d0JBQzlCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLOzZCQUNuRCxhQUFhLENBQUMsWUFBWSxDQUFDO3dCQUM5QixNQUFNLFFBQVEsR0FBRyxZQUFZLEtBQUssU0FBUyxHQUFHLGFBQWEsQ0FBQzt3QkFDNUQsSUFBSSxRQUFRLEVBQUU7NEJBQ1osa0NBQWtDOzRCQUNsQyxJQUFJLElBQUksQ0FBQyxZQUFZLEtBQUssRUFBRSxFQUFFO2dDQUM1QixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQztnQ0FDOUMsTUFBTSxPQUFPLEdBQ1gsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUM7Z0NBQ3JELElBQUksQ0FBQyxlQUFlLEdBQUc7b0NBQ3JCLEdBQUcsSUFBSSxDQUFDLGVBQWU7b0NBQ3ZCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQztpQ0FDNUMsQ0FBQzs2QkFDSDt5QkFDRjtvQkFDSCxDQUFDLENBQUMsQ0FBQztpQkFDTjtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBRUQsWUFBWSxDQUFDLEtBQWE7UUFDeEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVPLG9CQUFvQjtRQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7YUFDeEIsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDWixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUM7YUFDRCxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxDQUFDO2FBQzlDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxTQUFvQixFQUFFLGlCQUF1RDtRQUN0RyxNQUFNLGdCQUFnQixHQUFHLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNsRSxJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUNuRixDQUFDO0lBRU8sU0FBUyxDQUFDLEtBQXFCO1FBQ3JDLElBQUksS0FBSyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLEVBQUU7WUFDdEQscUZBQXFGO1lBQ3JGLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUN6QyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsS0FBSyxLQUFLLENBQUMsVUFBVSxDQUN6QyxDQUFDO1lBQ0YsSUFBSSxDQUFDLENBQUMsZUFBZSxFQUFFO2dCQUNyQixLQUFLLEdBQUcsZUFBZSxDQUFDO2FBQ3pCO1NBQ0Y7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLElBQUksRUFBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDekMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVPLFdBQVcsQ0FBQyxJQUFZO1FBQzlCLFFBQVEsSUFBSSxFQUFFO1lBQ1osS0FBSyxJQUFJO2dCQUNQLE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqRixLQUFLLElBQUk7Z0JBQ1AsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pGLEtBQUssSUFBSTtnQkFDUCxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDakYsS0FBSyxJQUFJO2dCQUNQLE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqRixLQUFLLElBQUk7Z0JBQ1AsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pGLEtBQUssSUFBSTtnQkFDUCxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDakYsS0FBSyxJQUFJO2dCQUNQLE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqRixLQUFLLElBQUk7Z0JBQ1AsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pGLEtBQUssSUFBSTtnQkFDUCxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDakYsS0FBSyxJQUFJO2dCQUNQLE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqRixLQUFLLElBQUk7Z0JBQ1AsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pGLEtBQUssSUFBSTtnQkFDUCxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDakYsS0FBSyxJQUFJO2dCQUNQLE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqRixLQUFLLElBQUk7Z0JBQ1AsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pGO2dCQUNFLE9BQU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMvRTtJQUNILENBQUM7SUFFTyxPQUFPLENBQUMsS0FBYTtRQUMzQixNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFeEMsdUNBQXVDO1FBQ3ZDLElBQUksSUFBSSxDQUFDLGFBQWEsSUFBSSxXQUFXLEtBQUssRUFBRSxFQUFFO1lBQzVDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNwRTthQUFNO1lBQ0wsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FDMUMsQ0FBQyxNQUFlLEVBQUUsRUFBRSxDQUNsQixNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7Z0JBQy9DLE1BQU0sQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQztnQkFDckQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQ3hELENBQUM7U0FDSDtRQUVELHlHQUF5RztRQUN6RyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzVCLENBQUM7OztZQWpSRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLG9CQUFvQjtnQkFDOUIsaW5EQUFnRDtnQkFFaEQsU0FBUyxFQUFFO29CQUNUO3dCQUNFLE9BQU8sRUFBRSxpQkFBaUI7d0JBQzFCLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMseUJBQXlCLENBQUM7d0JBQ3hELEtBQUssRUFBRSxJQUFJO3FCQUNaO2lCQUNGOzthQUNGOzs7eUNBMENJLE1BQU0sU0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMseUJBQXlCLENBQUM7WUE3RnJELGlCQUFpQjs7O3lCQXNEaEIsS0FBSzt3QkFDTCxLQUFLO29CQUNMLEtBQUs7MEJBQ0wsS0FBSzt1QkFDTCxLQUFLO3VCQUNMLEtBQUs7dUJBQ0wsS0FBSzt1QkFDTCxLQUFLO3VCQUNMLEtBQUs7b0JBQ0wsS0FBSzs0QkFDTCxLQUFLO3NCQUNMLEtBQUs7OEJBQ0wsS0FBSztnQ0FDTCxLQUFLO2tDQUNMLEtBQUs7b0NBRUwsU0FBUyxTQUFDLHFCQUFxQjtrQ0FDL0IsU0FBUyxTQUFDLHNCQUFzQjsyQkFDaEMsU0FBUyxTQUFDLFFBQVE7Z0NBR2xCLE1BQU07b0JBMEJOLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFdmVudEVtaXR0ZXIsXG4gIGZvcndhcmRSZWYsXG4gIEluamVjdCxcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE91dHB1dCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgTWF0QXV0b2NvbXBsZXRlLCBNYXRBdXRvY29tcGxldGVTZWxlY3RlZEV2ZW50LCBNYXRBdXRvY29tcGxldGVUcmlnZ2VyIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvYXV0b2NvbXBsZXRlJztcbmltcG9ydCB7IE1hdEZvcm1GaWVsZEFwcGVhcmFuY2UgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9mb3JtLWZpZWxkJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgZnJvbUV2ZW50LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIHN0YXJ0V2l0aCwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTWF0U2VsZWN0Q291bnRyeUxhbmdUb2tlbiB9IGZyb20gJy4vdG9rZW5zJztcbmltcG9ydCB7IE1hdElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvaW5wdXQnO1xuXG4vKipcbiAqIENvdW50cnkgaW50ZXJmYWNlIElTTyAzMTY2XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ291bnRyeSB7XG4gIG5hbWU6IHN0cmluZztcbiAgYWxwaGEyQ29kZTogc3RyaW5nO1xuICBhbHBoYTNDb2RlOiBzdHJpbmc7XG4gIG51bWVyaWNDb2RlOiBzdHJpbmc7XG4gIGNhbGxpbmdDb2RlOiBzdHJpbmc7XG59XG5cbnR5cGUgT3B0aW9uYWw8VCwgSyBleHRlbmRzIGtleW9mIFQ+ID0gT21pdDxULCBLPiAmIFBhcnRpYWw8VD47XG50eXBlIENvdW50cnlPcHRpb25hbE1hbmRhdG9yeUFscGhhMkNvZGUgPSBPcHRpb25hbDxDb3VudHJ5LCAnYWxwaGEzQ29kZScgfCAnbmFtZScgfCAnY2FsbGluZ0NvZGUnIHwgJ251bWVyaWNDb2RlJz47XG5cbi8qKlxuICogQGF1dGhvciBBbnRob255IE5haGFzXG4gKiBAc2luY2UgMTEuMTlcbiAqIEB2ZXJzaW9uIDIuMS4wXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ21hdC1zZWxlY3QtY291bnRyeScsXG4gIHRlbXBsYXRlVXJsOiAnbWF0LXNlbGVjdC1jb3VudHJ5LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJ21hdC1zZWxlY3QtY291bnRyeS5jb21wb25lbnQuc2NzcyddLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IE1hdFNlbGVjdENvdW50cnlDb21wb25lbnQpLFxuICAgICAgbXVsdGk6IHRydWUsXG4gICAgfSxcbiAgXSxcbn0pXG5leHBvcnQgY2xhc3MgTWF0U2VsZWN0Q291bnRyeUNvbXBvbmVudFxuICBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIENvbnRyb2xWYWx1ZUFjY2Vzc29yIHtcbiAgQElucHV0KCkgYXBwZWFyYW5jZTogTWF0Rm9ybUZpZWxkQXBwZWFyYW5jZTtcbiAgQElucHV0KCkgY291bnRyaWVzOiBDb3VudHJ5W10gPSBbXTtcbiAgQElucHV0KCkgbGFiZWw6IHN0cmluZztcbiAgQElucHV0KCkgcGxhY2VIb2xkZXIgPSAnU2VsZWN0IGNvdW50cnknO1xuICBASW5wdXQoKSByZXF1aXJlZDogYm9vbGVhbjtcbiAgQElucHV0KCkgZGlzYWJsZWQ6IGJvb2xlYW47XG4gIEBJbnB1dCgpIG51bGxhYmxlOiBib29sZWFuO1xuICBASW5wdXQoKSByZWFkb25seTogYm9vbGVhbjtcbiAgQElucHV0KCkgdGFiSW5kZXg6IG51bWJlciB8IHN0cmluZztcbiAgQElucHV0KCkgY2xhc3M6IHN0cmluZztcbiAgQElucHV0KCkgaXRlbXNMb2FkU2l6ZTogbnVtYmVyO1xuICBASW5wdXQoKSBsb2FkaW5nOiBib29sZWFuO1xuICBASW5wdXQoKSBzaG93Q2FsbGluZ0NvZGUgPSBmYWxzZTtcbiAgQElucHV0KCkgZXhjbHVkZWRDb3VudHJpZXM6IENvdW50cnlPcHRpb25hbE1hbmRhdG9yeUFscGhhMkNvZGVbXSA9IFtdO1xuICBASW5wdXQoKSBicm93c2VyQXV0b2NvbXBsZXRlOiBzdHJpbmc7XG5cbiAgQFZpZXdDaGlsZCgnY291bnRyeUF1dG9jb21wbGV0ZScpIHN0YXRlc0F1dG9jb21wbGV0ZVJlZjogTWF0QXV0b2NvbXBsZXRlO1xuICBAVmlld0NoaWxkKE1hdEF1dG9jb21wbGV0ZVRyaWdnZXIpIGF1dG9jb21wbGV0ZVRyaWdnZXI6IE1hdEF1dG9jb21wbGV0ZVRyaWdnZXI7XG4gIEBWaWV3Q2hpbGQoTWF0SW5wdXQpIGlucHV0RWxlbWVudDogTWF0SW5wdXQ7XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1vdXRwdXQtb24tcHJlZml4XG4gIEBPdXRwdXQoKSBvbkNvdW50cnlTZWxlY3RlZDogRXZlbnRFbWl0dGVyPENvdW50cnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxDb3VudHJ5PigpO1xuXG4gIGZpbHRlcmVkT3B0aW9uczogQ291bnRyeVtdO1xuICBkYjogQ291bnRyeVtdO1xuICBsb2FkaW5nREI6IGJvb2xlYW47XG4gIGRlYm91bmNlVGltZSA9IDMwMDtcbiAgZmlsdGVyU3RyaW5nID0gJyc7XG5cbiAgcHJpdmF0ZSBtb2RlbENoYW5nZWQ6IFN1YmplY3Q8c3RyaW5nPiA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcbiAgcHJpdmF0ZSBjb3VudHJpZXMkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDb3VudHJ5W10+KFtdKTtcbiAgcHJpdmF0ZSBleGNsdWRlZENvdW50cmllcyQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PENvdW50cnlbXT4oW10pO1xuICBwcml2YXRlIHZhbHVlJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q291bnRyeT4obnVsbCk7XG4gIHByaXZhdGUgdW5zdWJzY3JpYmUkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IHZhcmlhYmxlLW5hbWVcbiAgcHJpdmF0ZSBfdmFsdWU6IENvdW50cnk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChmb3J3YXJkUmVmKCgpID0+IE1hdFNlbGVjdENvdW50cnlMYW5nVG9rZW4pKSBwdWJsaWMgaTE4bjogc3RyaW5nLFxuICAgIHByaXZhdGUgY2RSZWY6IENoYW5nZURldGVjdG9yUmVmXG4gICkge31cblxuICBnZXQgdmFsdWUoKTogQ291bnRyeSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlO1xuICB9XG5cbiAgQElucHV0KClcbiAgc2V0IHZhbHVlKHZhbHVlOiBDb3VudHJ5KSB7XG4gICAgLy8gc2V0dGluZyBhIHZhbHVlIG9uIGEgcmVhY3RpdmUgZm9ybSAoZm9ybUNvbnRyb2xOYW1lKSBkb2Vzbid0IHRyaWdnZXIgbmdPbkNoYW5nZXMgYnV0IGl0IGRvZXMgY2FsbCB0aGlzIHNldHRlclxuICAgIHRoaXMudmFsdWUkLm5leHQodmFsdWUpO1xuICB9XG5cbiAgcHJvcGFnYXRlQ2hhbmdlID0gKF86IGFueSkgPT4ge307XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLmNvdW50cmllcyQsXG4gICAgICB0aGlzLnZhbHVlJCxcbiAgICAgIHRoaXMuZXhjbHVkZWRDb3VudHJpZXMkXG4gICAgXSlcbiAgICAgIC5waXBlKFxuICAgICAgICAvLyBmaXhpbmcgdGhlIGdsaXRjaCBvbiBjb21iaW5lTGF0ZXN0IGh0dHBzOi8vYmxvZy5zdHJvbmdicmV3LmlvL2NvbWJpbmUtbGF0ZXN0LWdsaXRjaC9cbiAgICAgICAgZGVib3VuY2VUaW1lKDApLFxuICAgICAgICB0YWtlVW50aWwodGhpcy51bnN1YnNjcmliZSQpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCggW2NvdW50cmllcywgdmFsdWUsIGV4Y2x1ZGVkQ291bnRyaWVzXSApID0+IHtcbiAgICAgICAgdGhpcy5fcG9wdWxhdGVDb3VudHJpZXMoY291bnRyaWVzLCBleGNsdWRlZENvdW50cmllcyk7XG4gICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgIHRoaXMuX3NldFZhbHVlKCB2YWx1ZSApO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIGlmICghdGhpcy5jb3VudHJpZXMubGVuZ3RoKSB7XG4gICAgICB0aGlzLl9sb2FkQ291bnRyaWVzRnJvbURiKCk7XG4gICAgfVxuXG4gICAgdGhpcy5tb2RlbENoYW5nZWRcbiAgICAgIC5waXBlKFxuICAgICAgICBzdGFydFdpdGgoJycpLFxuICAgICAgICBkZWJvdW5jZVRpbWUodGhpcy5kZWJvdW5jZVRpbWUpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy51bnN1YnNjcmliZSQpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCh2YWx1ZSkgPT4ge1xuICAgICAgICB0aGlzLmZpbHRlclN0cmluZyA9IHZhbHVlO1xuICAgICAgICB0aGlzLl9maWx0ZXIodmFsdWUpO1xuICAgICAgfSk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKGNoYW5nZXMuY291bnRyaWVzPy5jdXJyZW50VmFsdWUpIHtcbiAgICAgIHRoaXMuY291bnRyaWVzJC5uZXh0KGNoYW5nZXMuY291bnRyaWVzLmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuXG4gICAgaWYgKGNoYW5nZXMuZXhjbHVkZWRDb3VudHJpZXM/LmN1cnJlbnRWYWx1ZSkge1xuICAgICAgdGhpcy5leGNsdWRlZENvdW50cmllcyQubmV4dChjaGFuZ2VzLmV4Y2x1ZGVkQ291bnRyaWVzLmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgb25CbHVyKCkge1xuICAgIGlmICghdGhpcy5pbnB1dEVsZW1lbnQudmFsdWUgJiYgdGhpcy5udWxsYWJsZSAmJiB0aGlzLnN0YXRlc0F1dG9jb21wbGV0ZVJlZi5wYW5lbCkge1xuICAgICAgdGhpcy5fc2V0VmFsdWUobnVsbCk7XG4gICAgICB0aGlzLm9uQ291bnRyeVNlbGVjdGVkLmVtaXQobnVsbCk7XG4gICAgfVxuICB9XG5cbiAgb25PcHRpb25zU2VsZWN0ZWQoJGV2ZW50OiBNYXRBdXRvY29tcGxldGVTZWxlY3RlZEV2ZW50KSB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmNvdW50cmllcy5maW5kKFxuICAgICAgKGNvdW50cnkpID0+IGNvdW50cnkubmFtZSA9PT0gJGV2ZW50Lm9wdGlvbi52YWx1ZVxuICAgICk7XG4gICAgdGhpcy5fc2V0VmFsdWUodmFsdWUpO1xuICAgIHRoaXMub25Db3VudHJ5U2VsZWN0ZWQuZW1pdCh2YWx1ZSk7XG4gIH1cblxuICB3cml0ZVZhbHVlKG9iajogYW55KTogdm9pZCB7XG4gICAgaWYgKG9iaikge1xuICAgICAgdGhpcy52YWx1ZSA9IG9iajtcbiAgICB9XG4gIH1cblxuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLnByb3BhZ2F0ZUNoYW5nZSA9IGZuO1xuICB9XG5cbiAgcmVnaXN0ZXJPblRvdWNoZWQoZm46IGFueSk6IHZvaWQge1xuICAgIC8vIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4nKTtcbiAgfVxuXG4gIHNldERpc2FibGVkU3RhdGU/KGlzRGlzYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLmRpc2FibGVkID0gaXNEaXNhYmxlZDtcbiAgfVxuXG4gIGF1dG9jb21wbGV0ZVNjcm9sbCgpIHtcbiAgICBpZiAodGhpcy5pdGVtc0xvYWRTaXplKSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIHRoaXMuc3RhdGVzQXV0b2NvbXBsZXRlUmVmICYmXG4gICAgICAgICAgdGhpcy5hdXRvY29tcGxldGVUcmlnZ2VyICYmXG4gICAgICAgICAgdGhpcy5zdGF0ZXNBdXRvY29tcGxldGVSZWYucGFuZWxcbiAgICAgICAgKSB7XG4gICAgICAgICAgZnJvbUV2ZW50KHRoaXMuc3RhdGVzQXV0b2NvbXBsZXRlUmVmLnBhbmVsLm5hdGl2ZUVsZW1lbnQsICdzY3JvbGwnKVxuICAgICAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuYXV0b2NvbXBsZXRlVHJpZ2dlci5wYW5lbENsb3NpbmdBY3Rpb25zKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBzY3JvbGxUb3AgPSB0aGlzLnN0YXRlc0F1dG9jb21wbGV0ZVJlZi5wYW5lbC5uYXRpdmVFbGVtZW50XG4gICAgICAgICAgICAgICAgLnNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgY29uc3Qgc2Nyb2xsSGVpZ2h0ID0gdGhpcy5zdGF0ZXNBdXRvY29tcGxldGVSZWYucGFuZWxcbiAgICAgICAgICAgICAgICAubmF0aXZlRWxlbWVudC5zY3JvbGxIZWlnaHQ7XG4gICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRIZWlnaHQgPSB0aGlzLnN0YXRlc0F1dG9jb21wbGV0ZVJlZi5wYW5lbFxuICAgICAgICAgICAgICAgIC5uYXRpdmVFbGVtZW50LmNsaWVudEhlaWdodDtcbiAgICAgICAgICAgICAgY29uc3QgYXRCb3R0b20gPSBzY3JvbGxIZWlnaHQgPT09IHNjcm9sbFRvcCArIGVsZW1lbnRIZWlnaHQ7XG4gICAgICAgICAgICAgIGlmIChhdEJvdHRvbSkge1xuICAgICAgICAgICAgICAgIC8vIGZldGNoIG1vcmUgZGF0YSBpZiBub3QgZmlsdGVyZWRcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWx0ZXJTdHJpbmcgPT09ICcnKSB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBmcm9tSW5kZXggPSB0aGlzLmZpbHRlcmVkT3B0aW9ucy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICBjb25zdCB0b0luZGV4OiBudW1iZXIgPVxuICAgICAgICAgICAgICAgICAgICArdGhpcy5maWx0ZXJlZE9wdGlvbnMubGVuZ3RoICsgK3RoaXMuaXRlbXNMb2FkU2l6ZTtcbiAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRPcHRpb25zID0gW1xuICAgICAgICAgICAgICAgICAgICAuLi50aGlzLmZpbHRlcmVkT3B0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5jb3VudHJpZXMuc2xpY2UoZnJvbUluZGV4LCB0b0luZGV4KSxcbiAgICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgaW5wdXRDaGFuZ2VkKHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLm1vZGVsQ2hhbmdlZC5uZXh0KHZhbHVlKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMudW5zdWJzY3JpYmUkLm5leHQoKTtcbiAgICB0aGlzLnVuc3Vic2NyaWJlJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfbG9hZENvdW50cmllc0Zyb21EYigpOiB2b2lkIHtcbiAgICB0aGlzLmxvYWRpbmdEQiA9IHRydWU7XG4gICAgdGhpcy5faW1wb3J0TGFuZyh0aGlzLmkxOG4pXG4gICAgICAudGhlbigocmVzKSA9PiB7XG4gICAgICAgIHRoaXMuY291bnRyaWVzJC5uZXh0KHJlcyk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnIpID0+IGNvbnNvbGUuZXJyb3IoJ0Vycm9yOiAnICsgZXJyKSlcbiAgICAgIC5maW5hbGx5KCgpID0+IHRoaXMubG9hZGluZ0RCID0gZmFsc2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcG9wdWxhdGVDb3VudHJpZXMoY291bnRyaWVzOiBDb3VudHJ5W10sIGV4Y2x1ZGVkQ291bnRyaWVzOiBDb3VudHJ5T3B0aW9uYWxNYW5kYXRvcnlBbHBoYTJDb2RlW10pOiB2b2lkIHtcbiAgICBjb25zdCBleGNsdWRlQ291bnRyaWVzID0gZXhjbHVkZWRDb3VudHJpZXMubWFwKGMgPT4gYy5hbHBoYTJDb2RlKTtcbiAgICB0aGlzLmNvdW50cmllcyA9IGNvdW50cmllcy5maWx0ZXIoYyA9PiAhZXhjbHVkZUNvdW50cmllcy5pbmNsdWRlcyhjLmFscGhhMkNvZGUpKTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldFZhbHVlKHZhbHVlOiBDb3VudHJ5IHwgbnVsbCk6IHZvaWQge1xuICAgIGlmICh2YWx1ZSAmJiAoIXZhbHVlLm5hbWUgfHwgdmFsdWUubmFtZSA9PT0gJ1Vua25vd24nKSkge1xuICAgICAgLy8gbG9va3VwIG5hbWUgYmFzZWQgb24gYWxwaGEyIHZhbHVlcyBjb3VsZCBiZSBleHRlbmRlZCB0byBsb29rdXAgb24gb3RoZXIgdmFsdWVzIHRvb1xuICAgICAgY29uc3QgbWF0Y2hpbmdDb3VudHJ5ID0gdGhpcy5jb3VudHJpZXMuZmluZChcbiAgICAgICAgKGMpID0+IGMuYWxwaGEyQ29kZSA9PT0gdmFsdWUuYWxwaGEyQ29kZVxuICAgICAgKTtcbiAgICAgIGlmICghIW1hdGNoaW5nQ291bnRyeSkge1xuICAgICAgICB2YWx1ZSA9IG1hdGNoaW5nQ291bnRyeTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLl92YWx1ZSA9IHZhbHVlPy5uYW1lID8gdmFsdWUgOiBudWxsO1xuICAgIHRoaXMucHJvcGFnYXRlQ2hhbmdlKHRoaXMuX3ZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgX2ltcG9ydExhbmcoaTE4bjogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICBzd2l0Y2ggKGkxOG4pIHtcbiAgICAgIGNhc2UgJ2JyJzpcbiAgICAgICAgcmV0dXJuIGltcG9ydCgnLi9pMThuL2JyJykudGhlbihyZXN1bHQgPT4gcmVzdWx0LkNPVU5UUklFU19EQl9CUikudGhlbih5ID0+IHkpO1xuICAgICAgY2FzZSAnYnknOlxuICAgICAgICByZXR1cm4gaW1wb3J0KCcuL2kxOG4vYnknKS50aGVuKHJlc3VsdCA9PiByZXN1bHQuQ09VTlRSSUVTX0RCX0JZKS50aGVuKHkgPT4geSk7XG4gICAgICBjYXNlICdkZSc6XG4gICAgICAgIHJldHVybiBpbXBvcnQoJy4vaTE4bi9kZScpLnRoZW4ocmVzdWx0ID0+IHJlc3VsdC5DT1VOVFJJRVNfREJfREUpLnRoZW4oeSA9PiB5KTtcbiAgICAgIGNhc2UgJ2VzJzpcbiAgICAgICAgcmV0dXJuIGltcG9ydCgnLi9pMThuL2VzJykudGhlbihyZXN1bHQgPT4gcmVzdWx0LkNPVU5UUklFU19EQl9FUykudGhlbih5ID0+IHkpO1xuICAgICAgY2FzZSAnZnInOlxuICAgICAgICByZXR1cm4gaW1wb3J0KCcuL2kxOG4vZnInKS50aGVuKHJlc3VsdCA9PiByZXN1bHQuQ09VTlRSSUVTX0RCX0ZSKS50aGVuKHkgPT4geSk7XG4gICAgICBjYXNlICdocic6XG4gICAgICAgIHJldHVybiBpbXBvcnQoJy4vaTE4bi9ocicpLnRoZW4ocmVzdWx0ID0+IHJlc3VsdC5DT1VOVFJJRVNfREJfSFIpLnRoZW4oeSA9PiB5KTtcbiAgICAgIGNhc2UgJ2l0JzpcbiAgICAgICAgcmV0dXJuIGltcG9ydCgnLi9pMThuL2l0JykudGhlbihyZXN1bHQgPT4gcmVzdWx0LkNPVU5UUklFU19EQl9JVCkudGhlbih5ID0+IHkpO1xuICAgICAgY2FzZSAnbmwnOlxuICAgICAgICByZXR1cm4gaW1wb3J0KCcuL2kxOG4vbmwnKS50aGVuKHJlc3VsdCA9PiByZXN1bHQuQ09VTlRSSUVTX0RCX05MKS50aGVuKHkgPT4geSk7XG4gICAgICBjYXNlICdwdCc6XG4gICAgICAgIHJldHVybiBpbXBvcnQoJy4vaTE4bi9wdCcpLnRoZW4ocmVzdWx0ID0+IHJlc3VsdC5DT1VOVFJJRVNfREJfUFQpLnRoZW4oeSA9PiB5KTtcbiAgICAgIGNhc2UgJ3J1JzpcbiAgICAgICAgcmV0dXJuIGltcG9ydCgnLi9pMThuL3J1JykudGhlbihyZXN1bHQgPT4gcmVzdWx0LkNPVU5UUklFU19EQl9SVSkudGhlbih5ID0+IHkpO1xuICAgICAgY2FzZSAndWEnOlxuICAgICAgICByZXR1cm4gaW1wb3J0KCcuL2kxOG4vdWEnKS50aGVuKHJlc3VsdCA9PiByZXN1bHQuQ09VTlRSSUVTX0RCX1VBKS50aGVuKHkgPT4geSk7XG4gICAgICBjYXNlICdnbCc6XG4gICAgICAgIHJldHVybiBpbXBvcnQoJy4vaTE4bi9nbCcpLnRoZW4ocmVzdWx0ID0+IHJlc3VsdC5DT1VOVFJJRVNfREJfR0wpLnRoZW4oeSA9PiB5KTtcbiAgICAgIGNhc2UgJ2V1JzpcbiAgICAgICAgcmV0dXJuIGltcG9ydCgnLi9pMThuL2V1JykudGhlbihyZXN1bHQgPT4gcmVzdWx0LkNPVU5UUklFU19EQl9FVSkudGhlbih5ID0+IHkpO1xuICAgICAgY2FzZSAnY2EnOlxuICAgICAgICByZXR1cm4gaW1wb3J0KCcuL2kxOG4vY2EnKS50aGVuKHJlc3VsdCA9PiByZXN1bHQuQ09VTlRSSUVTX0RCX0NBKS50aGVuKHkgPT4geSk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gaW1wb3J0KCcuL2kxOG4vZW4nKS50aGVuKHJlc3VsdCA9PiByZXN1bHQuQ09VTlRSSUVTX0RCKS50aGVuKHkgPT4geSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfZmlsdGVyKHZhbHVlOiBzdHJpbmcpIHtcbiAgICBjb25zdCBmaWx0ZXJWYWx1ZSA9IHZhbHVlLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAvLyBpZiBub3QgZmlsdGVyZWQsIGZldGNoIHJlZHVjZWQgYXJyYXlcbiAgICBpZiAodGhpcy5pdGVtc0xvYWRTaXplICYmIGZpbHRlclZhbHVlID09PSAnJykge1xuICAgICAgdGhpcy5maWx0ZXJlZE9wdGlvbnMgPSB0aGlzLmNvdW50cmllcy5zbGljZSgwLCB0aGlzLml0ZW1zTG9hZFNpemUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZpbHRlcmVkT3B0aW9ucyA9IHRoaXMuY291bnRyaWVzLmZpbHRlcihcbiAgICAgICAgKG9wdGlvbjogQ291bnRyeSkgPT5cbiAgICAgICAgICBvcHRpb24ubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGZpbHRlclZhbHVlKSB8fFxuICAgICAgICAgIG9wdGlvbi5hbHBoYTJDb2RlLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoZmlsdGVyVmFsdWUpIHx8XG4gICAgICAgICAgb3B0aW9uLmFscGhhM0NvZGUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhmaWx0ZXJWYWx1ZSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gb3B0aW9ucyBpbiB0aGUgVUkgYXJlIG5vdCB1cGRhdGVkIHdoZW4gdGhpcyBjb21wb25lbnQgaXMgdXNlZCB3aXRoaW4gYSBob3N0IGNvbXBvbmVudCB0aGF0IHVzZXMgT25QdXNoXG4gICAgdGhpcy5jZFJlZi5tYXJrRm9yQ2hlY2soKTtcbiAgfVxufVxuIl19